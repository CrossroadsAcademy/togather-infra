apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: jwt-auth
spec:
  targetSelectors:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      matchLabels:
        jwt: enabled

  # CORS must be in same policy as JWT since route-level policies override Gateway-level
  # CORS filter runs BEFORE JWT, so it handles OPTIONS preflight automatically
  cors:
    allowOrigins:
      - "http://localhost:5173"
      - "http://localhost:5174"
    allowMethods:
      - GET
      - POST
      - PATCH
      - DELETE
      - PUT
      - OPTIONS
    allowHeaders:
      - Authorization
      - Content-Type
    exposeHeaders:
      - x-envoy-upstream-service-time
      - x-request-id
    allowCredentials: true

  jwt:
    providers:
      - name: jwt-auth
        localJWKS:
          type: ValueRef
          valueRef:
            group: ""
            kind: ConfigMap
            name: jwt-symmetric-key
        # Extract token from Authorization header OR query param (for WebSocket)
        extractFrom:
          headers:
            - name: Authorization
              valuePrefix: "Bearer "
          params:
            - token
        claimToHeaders:
          - claim: accountId
            header: x-jwt-accountId
          - claim: fullname
            header: x-jwt-fullname
          - claim: role
            header: x-jwt-role
# https://gateway.envoyproxy.io/docs/tasks/security/jwt-authentication/
#  we are using symmetric keys  and local secrect management

# You cannot automatically generate headers for every possible field without
# listing them; the API requires you to enumerate claimâ†’header mappings or use the single forward_payload_header to carry the full JSON payload.
